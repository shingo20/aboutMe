<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>YouTube 指定時刻で通知＆自動再生</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    body{margin:0;font-family:sans-serif;background:#0f172a;color:#f9fafb;padding:20px}
    .card{background:#111827;padding:20px;border-radius:16px;max-width:600px;margin:auto}
    label{display:block;margin:12px 0 6px}
    input,button{font:inherit;padding:10px;border-radius:8px}
    input[type="url"],input[type="datetime-local"]{width:100%;border:1px solid #444;background:#0b1020;color:white}
    .btn{margin-top:12px;padding:12px 16px;border:none;cursor:pointer;border-radius:8px;font-weight:bold}
    .primary{background:#22d3ee;color:#06202a}
    .ghost{background:transparent;border:1px solid #888;color:white}
    .list{margin-top:20px}
    .item{background:#1e293b;padding:12px;border-radius:10px;margin-bottom:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>📺 YouTube 指定時刻で通知</h1>
    <p>URLと日時を指定すると、その時刻に通知が届き、クリックでYouTubeを開きます。</p>

    <label for="videoUrl">YouTube動画URL</label>
    <input id="videoUrl" type="url" placeholder="https://www.youtube.com/watch?v=XXXXXXXX" />

    <label for="onceDateTime">日時</label>
    <input id="onceDateTime" type="datetime-local" />

    <button id="enableNotif" class="btn ghost" type="button">🔔 通知を許可</button>
    <button id="addSchedule" class="btn primary" type="button">▶ 予約を追加</button>

    <div id="status" style="margin-top:12px;font-size:14px;color:#9ca3af">準備中</div>

    <h3>📅 登録済みスケジュール</h3>
    <div id="list" class="list"></div>
  </div>

  <script>
    // ===== 通知の許可リクエスト =====
    async function requestNotificationPermission() {
      if (!("Notification" in window)) { alert("通知未対応ブラウザです"); return "unsupported"; }
      if (Notification.permission === "granted") return "granted";
      if (Notification.permission === "denied") return "denied";
      return await Notification.requestPermission();
    }

    function notify(title, body, url) {
      if (Notification.permission === "granted") {
        const n = new Notification(title, { body });
        n.onclick = () => { window.open(url, "_blank"); };
      }
    }

    // ===== スケジュール管理 =====
    const listEl = document.getElementById("list");
    const statusEl = document.getElementById("status");
    let schedules = [];

    function addSchedule(videoUrl, datetime) {
      const dt = new Date(datetime).getTime();
      if (!videoUrl || !dt) { alert("URLと日時を入力してください"); return; }
      const s = { id: Date.now(), videoUrl, dt };
      schedules.push(s);
      renderList();
    }

    function renderList() {
      listEl.innerHTML = "";
      for (const s of schedules) {
        const d = new Date(s.dt);
        const item = document.createElement("div");
        item.className = "item";
        item.textContent = `${d.toLocaleString()} - ${s.videoUrl}`;
        listEl.appendChild(item);
      }
    }

    function tick() {
      const now = Date.now();
      for (const s of schedules) {
        if (!s.fired && now >= s.dt) {
          notify("時間になりました ⏰", "YouTubeを開きます", s.videoUrl);
          s.fired = true;
        }
      }
      const next = schedules.filter(s=>!s.fired).map(s=>s.dt).sort()[0];
      if (next) {
        const remain = Math.max(0, next - now);
        const mins = Math.floor(remain / 60000);
        const secs = Math.floor((remain % 60000)/1000);
        statusEl.textContent = `次の発火まで ${mins}分${secs}秒`;
      } else {
        statusEl.textContent = "準備中";
      }
    }
    setInterval(tick,1000);

    // ===== イベント =====
    document.getElementById("enableNotif").onclick = requestNotificationPermission;
    document.getElementById("addSchedule").onclick = () => {
      addSchedule(
        document.getElementById("videoUrl").value,
        document.getElementById("onceDateTime").value
      );
    };
  </script>
</body>
</html>
